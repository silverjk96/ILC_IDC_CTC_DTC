---
title: "ILC CTC DTC_Neo"
output:
  pdf_document: default
  html_notebook: default
editor_options: 
  chunk_output_type: console
---


```{r}
#load data 
TIPPING_data <- read.csv("~/Desktop/Vantveer_Lab/TIPPING_data.csv")
View(TIPPING_data)

#load packages 
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(lubridate)
library(gtsummary)

#There are 1121 cases, of whom 379 received neoadjuvant therapy and 1 was missing neoadjuvant data
#cleaning removing neoadj patients 

TIPPING_data_cleaning_neo <- TIPPING_data %>%
  filter(neoadj == 1)


TIPPING_data_cleaning_both <- TIPPING_data %>%
  filter(neoadj == 1 | neoadj  == 0)
# 379 cases that did receive neoadj therapy

table(TIPPING_data_cleaning_neo$cleanhistology)


#cleaning histology . is missing 

TIPPING_data_cleaning_neo <- TIPPING_data_cleaning_neo %>%
  filter(cleanhistology != ".") 


TIPPING_data_cleaning_both <- TIPPING_data_cleaning_both %>%
  filter(cleanhistology != ".") 
# cleaning missting ctc info 

table(TIPPING_data_cleaning_neo$ctc_cont)

# for those missing CTC count, any have DTC? 

TIPPING_data_Missing_CTC <- TIPPING_data_cleaning %>% filter(is.na(ctc_cont))
#72 missing CTC 
TIPPING_data_Missing_CTC <- TIPPING_data_Missing_CTC %>% filter(!is.na(dtc_cont)) 
#63 missing CTC but have DTC (keep) and 

#missing both CTC and DTC 
#TIPPING_data_NA <- TIPPING_data_cleaning %>%
#  filter(is.na(ctc_cont)) %>%
#   filter(is.na(dtc_cont))
#omit missing both CTC and DTC = 9 cases 
#TIPPING_data_cleaning <- TIPPING_data_cleaning %>%
#  filter(patientid != "89") %>%
#  filter(patientid != "159") %>%
#  filter(patientid != "1073") %>%
#  filter(patientid != "1365") %>%
#  filter(patientid != "1849") %>%
 # filter(patientid != "1860") %>%
 # filter(patientid != "1867") %>%
#  filter(patientid != "1871") %>%
#  filter(patientid != "1872") 



TIPPING_data_cleaning_neo <- TIPPING_data_cleaning_neo %>%
  filter(ctc_cont != ".") 



TIPPING_data_cleaning_both <- TIPPING_data_cleaning_both %>%
  filter(ctc_cont != ".") 
#665 cases, of whom 540 have IDC and 77 have ILC.  38 have mixed ILC/IDC and 1 has inflammatory ILC

```

.
```{r}
# defining histology 

# 665 cases, of whom 540 have IDC and 77 have ILC.  38 have mixed ILC/IDC and 1 has inflammatory ILC

table(TIPPING_data_cleaning_neo$cleanhistology)

TIPPING_data_cleaning_neo <- TIPPING_data_cleaning_neo %>%
  mutate(histocat=cleanhistology,
  histocat=ifelse(histocat=="idc",2,
           ifelse(histocat=="adenocarcinoma",2,
           ifelse(histocat=="carcinoma",2,
           ifelse(histocat=="carcinom",2,
           ifelse(histocat=="micropapillary",2,
           ifelse(histocat=="neuroendocrine", 2,
           ifelse(histocat=="sweat duct", 2,
           ifelse(histocat=="metaplastic", 2,
           ifelse(histocat=="papillary",2,
           ifelse(histocat=="idc mixed",2,
           ifelse(histocat=="ilc",3,
           ifelse(histocat=="pilc",3,
           ifelse(histocat=="idc/ilc",4,
           ifelse(histocat=="ilc inflammatory",5,1)))))))))))))))

TIPPING_data_cleaning_both <- TIPPING_data_cleaning_both %>%
  mutate(histocat=cleanhistology,
  histocat=ifelse(histocat=="idc",2,
           ifelse(histocat=="adenocarcinoma",2,
           ifelse(histocat=="carcinoma",2,
           ifelse(histocat=="carcinom",2,
           ifelse(histocat=="micropapillary",2,
           ifelse(histocat=="neuroendocrine", 2,
           ifelse(histocat=="sweat duct", 2,
           ifelse(histocat=="metaplastic", 2,
           ifelse(histocat=="papillary",2,
           ifelse(histocat=="idc mixed",2,
           ifelse(histocat=="ilc",3,
           ifelse(histocat=="pilc",3,
           ifelse(histocat=="idc/ilc",4,
           ifelse(histocat=="ilc inflammatory",5,1)))))))))))))))


table(TIPPING_data_cleaning$histocat)

table(TIPPING_data_cleaning$histology)

hist <- TIPPING_data_cleaning_neo %>%
  filter(histology == "COMEDOCARCINOMA NOS" | histology == "INTRADUCTAL PAPILLARY ADENOCARCINOMA WITH INVASION"
         | histology == "NONINFILTRATING INTRADUCTAL PAPILLARY ADENOCARCINOMA" )
 
# change pateints 163, 1348, 1562 to have histocat 2 instead of 1 

TIPPING_data_cleaning_neo[105,23] <- 2
TIPPING_data_cleaning_neo[535,23] <- 2
TIPPING_data_cleaning_neo[441,23] <- 2


TIPPING_data_cleaning_both[132,23] <- 2
TIPPING_data_cleaning_both[651,23] <- 2
TIPPING_data_cleaning_both[797,23] <- 2
table(TIPPING_data_cleaning$histocat)

# 1"Other" 2"IDC" 3"ILC" 4"ILC/IDC" 5"Inflammatory ILC" 

# 1=9, 2 = 540, 3 = 77, 4 = 38, 5 =1 
```

```{r}

#label values histocat histolbl
#tab histocat 

#Make a category for just ILC or just IDC.  Excluding mixed idc/ilc*/

TIPPING_data_cleaning_histoilc_neo <- TIPPING_data_cleaning_neo %>%
  mutate(histoilc=histocat,
    histoilc=ifelse(histoilc==3,1,
            ifelse(histoilc==5,1,
            ifelse(histoilc==2,0,6))))

TIPPING_data_cleaning_histoilc_both <- TIPPING_data_cleaning_both %>%
  mutate(histoilc=histocat,
    histoilc=ifelse(histoilc==3,1,
            ifelse(histoilc==5,1,
            ifelse(histoilc==2,0,6))))
#Excluding mixed idc/ilc*/
TIPPING_data_cleaning_histoilc_allILC_neo <- TIPPING_data_cleaning_histoilc_neo %>%
    filter(histoilc == 1 | histoilc == 0 )
#677 cases all ILC and IDC , no mixed IDC/ILC


#*Make a categorical variable for either IDC, mixed ILC/IDC, or ILC*/

TIPPING_data_cleaning_cathisto3_neo <- TIPPING_data_cleaning_neo %>%
  mutate(cathisto3=histocat,
    cathisto3=ifelse(cathisto3==2,1,
            ifelse(cathisto3==4,2,
            ifelse(cathisto3==3,3,
            ifelse(cathisto3==5,3,6)))))

TIPPING_data_cleaning_cathisto3_both <- TIPPING_data_cleaning_both %>%
  mutate(cathisto3=histocat,
    cathisto3=ifelse(cathisto3==2,1,
            ifelse(cathisto3==4,2,
            ifelse(cathisto3==3,3,
            ifelse(cathisto3==5,3,6)))))
  
#label define cathistolbl 1"IDC" 2"ILC/IDC" 3"ILC" 
table(TIPPING_data_cleaning_cathisto3$cathisto3)
#593, 41, 84, 10 dcis???

#*Make a categorical variable for either IDC versus any ILC*/

TIPPING_data_cleaning_anyilc_neo  <- TIPPING_data_cleaning_cathisto3_neo %>%
  mutate(anyilc=cathisto3,
    anyilc=ifelse(anyilc==2,1,
            ifelse(anyilc==3,1,
            ifelse(anyilc==1,0,6))))


TIPPING_data_cleaning_anyilc_both  <- TIPPING_data_cleaning_cathisto3_both %>%
  mutate(anyilc=cathisto3,
    anyilc=ifelse(anyilc==2,1,
            ifelse(anyilc==3,1,
            ifelse(anyilc==1,0,6))))
  
  
#-------------------------------------




```

```{r}
#*Create a variable for tumor subtype*/

TIPPING_data_cleaning_neo <- TIPPING_data_cleaning_neo %>%
 mutate(subtype = case_when(
  hr == 1  & her2_n == 0 ~ 1,
  hr == 0 & her2_n == 0 ~ 2,
  her2_n == 1 ~ 3))
 #her2_n = 0 is her2 neg???  


TIPPING_data_cleaning_both <- TIPPING_data_cleaning_both %>%
 mutate(subtype = case_when(
  hr == 1  & her2_n == 0 ~ 1,
  hr == 0 & her2_n == 0 ~ 2,
  her2_n == 1 ~ 3))
table(TIPPING_data_cleaning$subtype)
with(TIPPING_data_cleaning, table(histocat, subtype))


#need N stage, T stage, overall stage? From tab 1 in dataset 

# need all data!
All_TIPPING_data_cleaning_neo <- All_TIPPING_Data %>%
  filter(neoadj == 1)
# 742 cases that did not receive neoadj therapy

#cleaning histology . is missing 

All_TIPPING_data_cleaning_neo <- All_TIPPING_data_cleaning_neo %>%
  filter(cleanhistology != ".") 
All_TIPPING_data_cleaning_both <- All_TIPPING_data_cleaning_both %>%
  filter(cleanhistology != ".") 
# cleaning missting ctc info 
joined_tipping_data_neo <- left_join(TIPPING_data_cleaning_neo, All_TIPPING_data_cleaning_neo[,c("invasivetumorsize", "totalpositivenodes")])

joined_tipping_data_neo <- left_join(TIPPING_data_cleaning_neo, All_TIPPING_data_cleaning_neo) 
joined_tipping_data_neo$neoadj

joined_tipping_data_both <- left_join(TIPPING_data_cleaning_both, All_TIPPING_data_cleaning_both) 
joined_tipping_data_neo$neoadj
#*Create variable for N stage*/

joined_tipping_data_neo <- joined_tipping_data_neo %>%
  mutate(nstage=totalpositivenodes,
    nstage=ifelse(nstage == 0, 0,
            ifelse(nstage > 0 & nstage < 3, 1,
            ifelse(nstage >= 3 & nstage < 9, 2,
            ifelse(nstage >= 9, 3,4)))))
table(joined_tipping_data$nstage)

joined_tipping_data_both <- joined_tipping_data_both %>%
  mutate(nstage=totalpositivenodes,
    nstage=ifelse(nstage == 0, 0,
            ifelse(nstage > 0 & nstage < 3, 1,
            ifelse(nstage >= 3 & nstage < 9, 2,
            ifelse(nstage >= 9, 3,4)))))

#*Create variable for T stage*/

joined_tipping_data_neo <- joined_tipping_data_neo %>%
  mutate(tstage=invasivetumorsize,
    tstage=ifelse(tstage >= 2 & tstage < 5, 2,
          ifelse(tstage >= 5, 3, 1)))


joined_tipping_data_both <- joined_tipping_data_both %>%
  mutate(tstage=invasivetumorsize,
    tstage=ifelse(tstage >= 2 & tstage < 5, 2,
          ifelse(tstage >= 5, 3, 1)))
table(joined_tipping_data$tstage)

#*Create variable for overall stage*/
joined_tipping_data_neo <- joined_tipping_data_neo %>%
    mutate(stage=
             ifelse(tstage==1 & nstage==1, 2,
             ifelse(tstage==2 & nstage==1, 2,
             ifelse(tstage==3 & nstage==0, 2, 
             ifelse(tstage==3 & nstage==1, 3,
             ifelse(nstage==2 , 3 , 1))))))

  table(joined_tipping_data$stage)
joined_tipping_data_both <- joined_tipping_data_both %>%
    mutate(stage=
             ifelse(tstage==1 & nstage==1, 2,
             ifelse(tstage==2 & nstage==1, 2,
             ifelse(tstage==3 & nstage==0, 2, 
             ifelse(tstage==3 & nstage==1, 3,
             ifelse(nstage==2 , 3 , 1))))))
  




 
```

```{r}
table(joined_tipping_data$histocat)
#label values histocat histolbl
#tab histocat 

#Make a category for just ILC or just IDC.  Excluding mixed idc/ilc*/

joined_tipping_data_histoilc_neo <- joined_tipping_data_neo %>%
  mutate(histoilc=histocat,
    histoilc=ifelse(histoilc==3,1,
            ifelse(histoilc==5,1,
            ifelse(histoilc==2,0,6))))

joined_tipping_data_histoilc_both <- joined_tipping_data_both %>%
  mutate(histoilc=histocat,
    histoilc=ifelse(histoilc==3,1,
            ifelse(histoilc==5,1,
            ifelse(histoilc==2,0,6))))

#Excluding mixed idc/ilc*/
joined_tipping_data_histoilc_allILC_neo <- joined_tipping_data_histoilc_neo %>%
    filter(histoilc == 1 | histoilc == 0 )
#677 cases all ILC and IDC , no mixed IDC/ILC


#*Make a categorical variable for either IDC, mixed ILC/IDC, or ILC*/

joined_tipping_data_cathisto3_neo <- joined_tipping_data_neo %>%
  mutate(cathisto3=histocat,
    cathisto3=ifelse(cathisto3==2,1,
            ifelse(cathisto3==4,2,
            ifelse(cathisto3==3,3,
            ifelse(cathisto3==5,3,6)))))

joined_tipping_data_cathisto3_both <- joined_tipping_data_both %>%
  mutate(cathisto3=histocat,
    cathisto3=ifelse(cathisto3==2,1,
            ifelse(cathisto3==4,2,
            ifelse(cathisto3==3,3,
            ifelse(cathisto3==5,3,6)))))
  
#label define cathistolbl 1"IDC" 2"ILC/IDC" 3"ILC" 
table(joined_tipping_data_cathisto3$cathisto3)
#593, 41, 84, 10 dcis???

#*Make a categorical variable for either IDC versus any ILC*/

joined_tipping_data_anyilc_neo  <- joined_tipping_data_cathisto3_neo %>%
  mutate(anyilc=cathisto3,
    anyilc=ifelse(anyilc==2,1,
            ifelse(anyilc==3,1,
            ifelse(anyilc==1,0,6))))


joined_tipping_data_anyilc_both  <- joined_tipping_data_cathisto3_both %>%
  mutate(anyilc=cathisto3,
    anyilc=ifelse(anyilc==2,1,
            ifelse(anyilc==3,1,
            ifelse(anyilc==1,0,6))))

joined_tipping_data_anyilc_neo$anyilc

table(joined_tipping_data_anyilc$anyilc)
#include cat 6?
       
    
```

```{r}
#*Describe the cohort of patients. ILC patients are significantly older, significantly more likely to be subtype 1 which is HRposHER2neg, significantly less likely to be grade 3, and have no difference in stage.*/

joined_tipping_data_anyilc_filter_neo <- joined_tipping_data_anyilc_neo %>%
  filter(anyilc == 0 | anyilc == 1) #327 cases 

joined_tipping_data_anyilc_filter_both <- joined_tipping_data_anyilc_both %>%
  filter(anyilc == 0 | anyilc == 1) 

joined_tipping_data_anyilc_filter_IE_FC_both <- joined_tipping_data_anyilc_both %>%
  filter(ctcmethod == "IE/FC") %>%
 filter(anyilc == 0 | anyilc == 1)

joined_tipping_data_anyilc_filter_IE_FC_both$anyilc
joined_tipping_data_anyilc_filter_IE_FC_both$ctcmethod

mean(joined_tipping_data_anyilc_filter_IE_FC_both$ctc_cont)
mean(joined_tipping_data_anyilc_filter_CS_both$ctc_cont)

with(joined_tipping_data_anyilc_filter_both, table(ctcmethod, anyilc))



dim(joined_tipping_data_anyilc_filter_IE_FC_both)

t.test(joined_tipping_data_anyilc_filter$ageatdx~joined_tipping_data_anyilc_filter$anyilc)

install.packages("gtsummary")
remotes::install_github("ddsjoberg/gtsummary")
library(gtsummary)
library(dplyr)

colnames(joined_tipping_data_anyilc_filter_neo)[4] <- "age"

 
joined_tipping_data_anyilc_filter_neo %>%
  select(anyilc, age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


  # no neoadjvant therapy

joined_tipping_data_anyilc_filter_IE_FC %>%
  select(anyilc, age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()



merged_joined_tipping_data_anyilc_filter_IE_FC_age <- merge(joined_tipping_data_anyilc_filter_IE_FC, PID_AGE_NA_updated, by = "patientid", all.x = TRUE)

merged_joined_tipping_data_anyilc_filter_IE_FC_age$age <- ifelse(is.na(merged_joined_tipping_data_anyilc_filter_IE_FC_age$age.x), merged_joined_tipping_data_anyilc_filter_IE_FC_age$age.y, merged_joined_tipping_data_anyilc_filter_IE_FC_age$age.x)

merged_joined_tipping_data_anyilc_filter_IE_FC_age <- merged_joined_tipping_data_anyilc_filter_IE_FC_age[, !(names(merged_joined_tipping_data_anyilc_filter_IE_FC_age) %in% c("age.x", "age.y"))]

  # no neoadjvant therapy

merged_joined_tipping_data_anyilc_filter_IE_FC_age %>%
  select(anyilc, age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()



joined_tipping_data_anyilc_filter_IE_FC_neo %>%
  select(anyilc, age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_IE_FC_both %>%
  select(neoadj, ageatdx, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

print(joined_tipping_data_anyilc_filter_neo)
table(joined_tipping_data_anyilc_filter_neo$cleanhistology)
dim(joined_tipping_data_anyilc_filter)
neoadj <- All_TIPPING_Data %>%
   filter(neoadj == 1)
noneadj <- All_TIPPING_Data %>%
   filter(neoadj == 0)
table(neoadj$ctc_cont)
dim(noneadj)

table(joined_tipping_data_anyilc_filter$cleanhistology)
dim(joined_tipping_data_anyilc_filter_CS_neo)
dim(joined_tipping_data_anyilc_filter_IE_FC_neo)
summary(joined_tipping_data_anyilc_filter_CS_neo)
joined_tipping_data_anyilc_filter_CS_neo$neoadj
table(joined_tipping_data_anyilc_filter_CS_neo$anyilc)

median(joined_tipping_data_anyilc_filter_IE_FC_IDC_neo$time_drfs)
median(joined_tipping_data_anyilc_filter_IE_FC_IDC_neo$time_os)


median(joined_tipping_data_anyilc_filter_IE_FC_ILC_neo$time_drfs)
median(joined_tipping_data_anyilc_filter_IE_FC_ILC_neo$time_os)


joined_tipping_data_anyilc_filter_IE_FC_both$anyilc <- factor(joined_tipping_data_anyilc_filter_IE_FC_both$anyilc, levels=c(0,1))

names(joined_tipping_data_anyilc_filter_IE_FC_both)


joined_tipping_data_anyilc_filter_IE_FC_both$anyilc <- factor(joined_tipping_data_anyilc_filter_IE_FC_both$anyilc, levels=c(0,1))

joined_tipping_data_anyilc_filter_IE_FC_both$neoadj <- factor(joined_tipping_data_anyilc_filter_IE_FC_both$neoadj, levels=c(0,1))

joined_tipping_data_anyilc_filter_IE_FC_both %>%
  select(neoadj, anyilc, ageatdx, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

#add age for those unknonwn age patients 
colnames(PID_AGE_NA_updated)[colnames(PID_AGE_NA_updated) == "age"] <- "ageatdx"

PID_AGE_NA_updated$patientid <- as.integer(PID_AGE_NA_updated$patientid)
PID_AGE_NA_updated$ageatdx <- as.integer(PID_AGE_NA_updated$ageatdx)

merged_joined_tipping_data_anyilc_filter_IE_FC_both_age <- merge(joined_tipping_data_anyilc_filter_IE_FC_both, PID_AGE_NA_updated, by = "patientid", all.x = TRUE)

merged_joined_tipping_data_anyilc_filter_IE_FC_both_age$ageatdx <- ifelse(is.na(merged_joined_tipping_data_anyilc_filter_IE_FC_both_age$ageatdx.x), merged_joined_tipping_data_anyilc_filter_IE_FC_both_age$ageatdx.y, merged_joined_tipping_data_anyilc_filter_IE_FC_both_age$ageatdx.x)

merged_joined_tipping_data_anyilc_filter_IE_FC_both_age <- merged_joined_tipping_data_anyilc_filter_IE_FC_both_age[, !(names(merged_joined_tipping_data_anyilc_filter_IE_FC_both_age) %in% c("ageatdx.x", "ageatdx.y"))]


merged_joined_tipping_data_anyilc_filter_IE_FC_both_age %>%
  select(neoadj, anyilc, ageatdx, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
   add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
  
  
median(joined_tipping_data_anyilc_filter_IE_FC_neo$time_drfs)
median(joined_tipping_data_anyilc_filter_IE_FC_neo$time_os)


median(joined_tipping_data_anyilc_filter_IE_FC$time_drfs)
median(joined_tipping_data_anyilc_filter_IE_FC$time_os)

#*Compare CTC counts by histology between IDC versus ILC*/

joined_tipping_data_anyilc_filter_neo %>%
  select(anyilc, ctc_cont) %>%
  tbl_summary(by = anyilc) %>%
  add_p() %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

t.test(joined_tipping_data_anyilc_filter_neo$ctc_cont~joined_tipping_data_anyilc_filter_neo$anyilc)
#stick with t.test and show means!!! 

library(ggpubr)

p <- ggboxplot(joined_tipping_data_anyilc_filter, x = "anyilc", y = "ctc_cont",
               color = "anyilc", palette =c("#0000FF", "#E7B800"),
               add = "boxplot")
my_comparisons <- list(c("0", "1")) 
p + stat_compare_means(comparisons = my_comparisons, method = "t.test" ) + # Add pairwise comparisons p-value
 # geom_hline(yintercept=0.02, linetype="dashed", color = "red", size=1) + ylim(0.1,2) 

#median_ctc_cont <- median(joined_tipping_data_anyilc_filter$ctc_cont)
   
   joined_tipping_data_anyilc_filter_IE_FC_neo <- joined_tipping_data_anyilc_filter_neo %>%
   filter(ctcmethod == "IE/FC")

 joined_tipping_data_anyilc_filter_CS_neo <- joined_tipping_data_anyilc_filter_neo %>%
   filter(ctcmethod == "CellSearch")
 
   mean(joined_tipping_data_anyilc_filter_IE_FC_neo$ctc_cont)
   mean(joined_tipping_data_anyilc_filter_IE_FC_ILC_neo$ctc_cont) #0.898

    mean(joined_tipping_data_anyilc_filter_CS_ILC_neo$ctc_cont) #0.0809
   median(joined_tipping_data_anyilc_filter_IE_FC_neo$ctc_cont)
   
   joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.44  ~ "CTC-",
  ctc_cont >= 0.44 ~ "CTC+"))

   joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(hist = case_when(
  anyilc == 0  ~ "IDC",
  anyilc == 1 ~ "ILC"))
       
     joined_tipping_data_anyilc_filter_CS <- joined_tipping_data_anyilc_filter_CS %>%
   mutate(hist = case_when(
  anyilc == 0  ~ "IDC",
  anyilc == 1 ~ "ILC"))
     
   ggplot(data = joined_tipping_data_anyilc_filter_IE_FC) +
   geom_mosaic(aes(x=product(ctccut,anyilc),fill=anyilc)) + 
scale_x_discrete() + scale_y_discrete() 

      
str(joined_tipping_data_anyilc_filter_IE_FC)
summary(joined_tipping_data_anyilc_filter_IE_FC$pluslogctc)

  joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(ctcquant = case_when(
  pluslogctc <= 1.1461  ~ "LOW",
  pluslogctc > 1.1461 & pluslogctc < 0.9085 ~ "MEDIUM",
  pluslogctc >= 0.9085 ~ "HIGH"))

  mosaicplot(~ anyilc + ctcquant, data = joined_tipping_data_anyilc_filter_IE_FC,
           main = "Histology and CTC count", shade = TRUE)
  
  library(vcd)
  
 conttable <- table(joined_tipping_data_anyilc_filter_IE_FC$ctcquant, joined_tipping_data_anyilc_filter_IE_FC$anyilc)

 mosaic(conttable)

 mosaicplot(conttable, main = deparse(substitute(x)),
           sub = NULL, xlab = NULL, ylab = NULL,
           sort = NULL, off = NULL, dir = NULL,
           color = NULL, shade = TRUE, margin = NULL,
           cex.axis = 0.66, las = par("las"), border = NULL ,
           type = c("pearson"))
 
 labs <- round(prop.table(conttable), 2)
mosaic(labs, pop = FALSE)

```


```{r}
#*What factors are associated with CTC counts? CTC counts are highest in HR pos HER2 negative cases*/

ggboxplot(joined_tipping_data_anyilc_filter, x = "grade", y = "ctc_cont", 
          color = "grade", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3"),
          ylab = "CTC count", xlab = "Grade")

kruskal.test(ctc_cont ~ grade, data = joined_tipping_data_anyilc_filter)
pairwise.wilcox.test(joined_tipping_data_anyilc_filter$ctc_cont, joined_tipping_data_anyilc_filter$grade,
                 p.adjust.method = "BH")


ggboxplot(joined_tipping_data_anyilc_filter, x = "stage", y = "ctc_cont", 
          color = "stage", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3"),
          ylab = "CTC count", xlab = "Stage")

kruskal.test(ctc_cont ~ stage, data = joined_tipping_data_anyilc_filter)
pairwise.wilcox.test(joined_tipping_data_anyilc_filter$ctc_cont, joined_tipping_data_anyilc_filter$stage,
                 p.adjust.method = "BH")


ggboxplot(joined_tipping_data_anyilc_filter, x = "subtype", y = "ctc_cont", 
          color = "subtype", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3"),
          ylab = "CTC count", xlab = "Subtype")

kruskal.test(ctc_cont ~ subtype, data = joined_tipping_data_anyilc_filter)
pairwise.wilcox.test(joined_tipping_data_anyilc_filter$ctc_cont, joined_tipping_data_anyilc_filter$subtype,
                 p.adjust.method = "BH")

```

```{r}
#*How do CTC counts vary by method of detection?.  CellSearch had lower yield of CTC's*/


library(magrittr)

CellSearch <- joined_tipping_data_anyilc_filter_neo %>% 
   filter(ctcmethod == "CellSearch") %$% sum(ctc_cont) #34.34

IE_FC <- joined_tipping_data_anyilc_filter_neo %>% 
   filter(ctcmethod == "IE/FC") %$% sum(ctc_cont) #287.89

t.test(joined_tipping_data_anyilc_filter$ctc_cont~joined_tipping_data_anyilc_filter$ctcmethod)

table(joined_tipping_data_anyilc_filter_neo$ctcmethod) #unknown ctc methods??
detection <- joined_tipping_data_anyilc_filter%>% 
   filter(ctcmethod == "IE/FC" | ctcmethod == "CellSearch") 

ggboxplot(detection, x = "ctcmethod", y = "ctc_cont",
               color = "ctcmethod", palette =c("#0000FF", "#E7B800"),
               add = "boxplot")

```

```{r}
#*Is there a difference in method of detection by histology?/  Yes, ILC patients had a significantly higher rate of IE/FC for detection*/

chi.test <- chisq.test(table(detection$anyilc, detection$ctcmethod))
chi.test

chi.test <- chisq.test(table(joined_tipping_data_anyilc_filter_both$anyilc, joined_tipping_data_anyilc_filter_both$ctcmethod))
chi.test

(table(joined_tipping_data_anyilc_filter$anyilc, joined_tipping_data_anyilc_filter$ctcmethod))

(table(joined_tipping_data_anyilc_neo$anyilc, joined_tipping_data_anyilc_neo$ctcmethod))

summary(joined_tipping_data_anyilc_neo)

chi.test <- chisq.test(table(joined_tipping_data_anyilc_both$anyilc, joined_tipping_data_anyilc_both$ctcmethod))
chi.test

library(summarytools)
library(dplyr)

detection %$%
  ctable(anyilc, ctcmethod,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )
```

```{r}
#*Make a new variable for CTC method*/


joined_tipping_data_anyilc_filter <- joined_tipping_data_anyilc_filter %>%
  mutate(ctcmethodclean=ctcmethod,
    ctcmethodclean=ifelse(ctcmethodclean=="CellSearch",1,
            ifelse(ctcmethodclean=="IE/FC",2,0)))

table(joined_tipping_data_anyilc_filter$ctcmethodclean)

```

```{r}
#*Make a variable for having at least >0 CTC*/

joined_tipping_data_anyilc_filter <- joined_tipping_data_anyilc_filter %>%
  mutate(ctcpos=ctc_cont,
    ctcpos=ifelse(ctcpos == 0, 0,
          ifelse(ctcpos > 0 , 1,2)))

joined_tipping_data_anyilc_filter %$%
  ctable(ctcpos, anyilc,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )
#*Among those who are CTC positive, are counts higher in ILC versus IDC? yes*/
ctcpos <- joined_tipping_data_anyilc_filter %>%
  filter(ctcpos==1)

t.test(ctcpos$ctc_cont~ctcpos$anyilc)

ggboxplot(ctcpos, x = "anyilc", y = "ctc_cont",
               color = "anyilc", palette =c("#0000FF", "#E7B800"),
               add = "boxplot")

#try speghettic plot to show individual increase???
```

```{r}
# Multiple Linear Regression Example: #*In a regression model having ILC histology is associated with higher CTC count
fit <- lm(ctc_cont ~ anyilc + stage + subtype + grade + age, data=joined_tipping_data_anyilc_filter_neo)
summary(fit) # show results

# Other useful functions
coefficients(fit) # model coefficients
confint(fit, level=0.95) # CIs for model parameters
fitted(fit) # predicted values
residuals(fit) # residuals
anova(fit) # anova table
vcov(fit) # covariance matrix for model parameters
influence(fit) # regression diagnostics

layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(fit)

# load package
library(sjPlot)
library(sjmisc)
library(sjlabelled)

tab_model(fit, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

#fit the same model to the different ctcmethods 

CellSearch <- joined_tipping_data_anyilc_filter %>% 
   filter(ctcmethod == "CellSearch")

IE_FC <- joined_tipping_data_anyilc_filter %>% 
   filter(ctcmethod == "IE/FC") 

fit2 <- lm(ctc_cont ~ anyilc + stage + subtype + grade + ageatdx, data=CellSearch)
tab_model(fit2, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit3 <- lm(ctc_cont ~ anyilc + stage + subtype + grade + ageatdx, data=IE_FC)
tab_model(fit3, show.se = TRUE, show.std = TRUE, show.stat = TRUE)


```

```{r}
#*Look at association between CTC count and recurrence*/


t.test(joined_tipping_data_anyilc_filter$ctc_cont~joined_tipping_data_anyilc_filter$anyrecurrenceyes1no0)
t.test(joined_tipping_data_anyilc_filter$ctc_cont~joined_tipping_data_anyilc_filter$distantrecurrenceyes1no0)
t.test(joined_tipping_data_anyilc_filter$ctc_cont~joined_tipping_data_anyilc_filter$deathduetobreastcanceryes1no0)
t.test(joined_tipping_data_anyilc_filter$ctc_cont~joined_tipping_data_anyilc_filter$ctc_bin2) ##change bin??

ctc_bin2_1 <- joined_tipping_data_anyilc_filter %>% 
   filter(ctc_bin2 == 1) %$% sum(ctc_cont) #288.93
ctc_bin2_0 <- joined_tipping_data_anyilc_filter %>% 
   filter(ctc_bin2 == 0) %$% sum(ctc_cont) #33.3


```

```{r}

#Make a cutoff of CTC <0.45*/ ##need to be adjusted?


joined_tipping_data_anyilc_filter <- joined_tipping_data_anyilc_filter %>%
  mutate(highctc=ctc_cont,
    highctc=ifelse(highctc < 0.45, 0,
          ifelse(highctc > 0.44 , 1,2)))

```

```{r}
joined_tipping_data_anyilc_filter_IE_FC_ILC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   filter(anyilc == 1)

joined_tipping_data_anyilc_filter_IE_FC_IDC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   filter(anyilc == 0)

joined_tipping_data_anyilc_filter_CS_ILC_neo <- joined_tipping_data_anyilc_filter_CS_neo %>%
   filter(anyilc == 1)

joined_tipping_data_anyilc_filter_CS_IDC_neo <- joined_tipping_data_anyilc_filter_CS_neo %>%
   filter(anyilc == 0)
 
joined_tipping_data_anyilc_filter_neo_ILC <- joined_tipping_data_anyilc_filter_neo %>%
 filter(anyilc == 1)
```

```{r}
#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)



```

```{r}
#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

```


```{r}

joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter %>%
   filter(ctcmethod == "IE/FC")

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}

joined_tipping_data_anyilc_filter_ILC <- joined_tipping_data_anyilc_filter %>%
   filter(anyilc == 1)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_ILC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_ILC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

```


```{r}
joined_tipping_data_anyilc_filter_IDC <- joined_tipping_data_anyilc_filter %>%
   filter(anyilc == 0)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IDC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IDC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

```

```{r}
joined_tipping_data_anyilc_filter_ILC <- joined_tipping_data_anyilc_filter %>%
   filter(anyilc == 1)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter_ILC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter_ILC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

```

```{r}
joined_tipping_data_anyilc_filter_IDC <- joined_tipping_data_anyilc_filter %>%
   filter(anyilc == 0)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter_IDC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter_IDC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_bin2, data = joined_tipping_data_anyilc_filter_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,20),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```


```{r}
# Cox Proportional-Hazards Model 

#stcox ctc_cont age i.stage  i.grade i.subtype if anyilc==0
#stcox highctc##i.anyilc age i.stage  i.grade i.subtype 


  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  

  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  


  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


```


```{r}
#histogram for histology 
joined_tipping_data_cathisto3 <- joined_tipping_data %>%
  mutate(cathisto3=histocat,
    cathisto3=ifelse(cathisto3==2,1,
            ifelse(cathisto3==4,2,
            ifelse(cathisto3==3,3,
            ifelse(cathisto3==5,3,6)))))
  
#label define cathistolbl 1"IDC" 2"ILC/IDC" 3"ILC" 
table(joined_tipping_data_cathisto3$cathisto3)
#593, 41, 84, 10 dcis???

joined_tipping_data_cathisto3_2_3 <- joined_tipping_data_cathisto3 %>%
  filter(cathisto3 == 2 | cathisto3 == 3 )

# creating a cetogry for ILC/IDC AND ILC together
#joined_tipping_data_cathisto3_2_3_4 <- joined_tipping_data_cathisto3_2_3 %>%
 # mutate(cathisto4 = case_when(
 # cathisto3 == 1  & her2_n == 0 ~ 1,
# hr == 0 & her2_n == 0 ~ 2,
  #her2_n == 1 ~ 3))

ggplot2.histogram(data=joined_tipping_data_cathisto3_2_3, xName='ctc_cont',
        groupName='cathisto3', legendPosition="top",
        alpha=0.5 )


joined_tipping_data_cathisto3_1_2_3 <- joined_tipping_data_cathisto3 %>%
  filter(cathisto3 == 2 | cathisto3 == 3 | cathisto3 == 1 )

ggplot2.histogram(data=joined_tipping_data_cathisto3_1_2_3, xName='ctc_cont',
        groupName='cathisto3', legendPosition="top",
        alpha=0.5 )
```

```{r}
#cohort table: redo by ctcmethod 
library(gtsummary)

joined_tipping_data_anyilc_filter_IE_FC_neo %>%
  select(anyilc,age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

#add age for those unknonwn age patients 
colnames(PID_AGE_NA_updated)[colnames(PID_AGE_NA_updated) == "ageatdx"] <- "age"

PID_AGE_NA_updated$patientid <- as.integer(PID_AGE_NA_updated$patientid)
PID_AGE_NA_updated$ageatdx <- as.integer(PID_AGE_NA_updated$age)

merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age <- merge(joined_tipping_data_anyilc_filter_IE_FC_neo, PID_AGE_NA_updated, by = "patientid", all.x = TRUE)

merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age$age <- ifelse(is.na(merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age$age.x), merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age$age.y, merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age$age.x)

merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age <- merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age[, !(names(merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age) %in% c("age.x", "age.y"))]


merged_joined_tipping_data_anyilc_filter_IE_FC_neo_age %>%
  select(anyilc,age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_CS_neo %>%
  select(anyilc,age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

   joined_tipping_data_anyilc_filter_IE_FC_neo %>%
  select(anyilc, ctc_cont,age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_CS <- joined_tipping_data_anyilc_filter %>% 
   filter(ctcmethod == "CellSearch")

 joined_tipping_data_anyilc_filter_CS_neo %>%
  select(anyilc, ctc_cont, age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc,  statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
 
 #cohort table: redo by all methods  
 
 joined_tipping_data_anyilc_filter_neo %>%
  select(anyilc, ctc_cont,age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
 
 joined_tipping_data_anyilc_filter_neo %>%
  select(ctcmethod, ctc_cont) %>%
  tbl_summary(by = ctcmethod, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     ctcmethod,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
 
 joined_tipping_data_anyilc_filter_both%>%
  select(ctcmethod, ctc_cont) %>%
  tbl_summary(by = ctcmethod, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     ctcmethod,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
 
   joined_tipping_data_anyilc_filter_ILC_both <- joined_tipping_data_anyilc_filter_both %>%
     filter(anyilc == 1)

  joined_tipping_data_anyilc_filter_both%>%
  select(ctcmethod, ctc_cont) %>%
  tbl_summary(by = ctcmethod, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     ctcmethod,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
 
   joined_tipping_data_anyilc_filter_IE_FC_both%>%
  select(anyilc, ctc_cont) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     ctcmethod,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
   
  table(joined_tipping_data_anyilc_filter_IE_FC_both$anyilc)
  
   
 joined_tipping_data_anyilc_filter_neo_ILC %>%
  select(ctcmethod, ctc_cont) %>%
  tbl_summary(by = ctcmethod, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     ctcmethod,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()
 
 table(joined_tipping_data_anyilc_filter_ILC$ctcmethod)
 

test <- chisq.test(table(joined_tipping_data_anyilc_filter_neo$anyilc, joined_tipping_data_anyilc_filter_neo$ctcmethod))
test

table(joined_tipping_data_anyilc_filter_neo$anyilc, joined_tipping_data_anyilc_filter_neo$ctcmethod)

median(joined_tipping_data_anyilc_filter_IE_FC_ILC_neo$ctc_cont)
#median = 0.135

median(joined_tipping_data_anyilc_filter_CS_ILC_neo$ctc_cont)
#median = 0 

```

```{r}
#Redo Make a variable for having at least >0 CTC*/ by ctcmethod

library(summarytools)

joined_tipping_data_anyilc_filter_IE_FC %$%
  ctable(ctcpos, anyilc,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )

joined_tipping_data_anyilc_filter_CS %$%
  ctable(ctcpos, anyilc,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )

```


```{r}
#linear regression model including ctcmethod 
library(sjPlot)
fit4 <- lm(ctc_cont ~ anyilc + ctcmethodclean + stage + subtype + grade + ageatdx, data=joined_tipping_data_anyilc_filter)
tab_model(fit4, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

joined_tipping_data_anyilc_filter_IE_FC$subtype <- factor(joined_tipping_data_anyilc_filter_IE_FC$subtype, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_IE_FC$stage <- factor(joined_tipping_data_anyilc_filter_IE_FC$stage, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_IE_FC$grade <- factor(joined_tipping_data_anyilc_filter_IE_FC$grade, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_IE_FC$anyilc <- factor(joined_tipping_data_anyilc_filter_IE_FC$anyilc, levels=c(0,1))


fit4 <- lm(ctc_cont ~ anyilc + stage + subtype + grade + ageatdx, data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit4, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit5 <- lm(ctc_cont ~ anyilc + ctcmethodclean, data=joined_tipping_data_anyilc_filter)
tab_model(fit5, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit6 <- lm(ctc_cont ~ ctcmethodclean, data=joined_tipping_data_anyilc_filter)
tab_model(fit6, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

joined_tipping_data_anyilc_filter_ILC$subtype <- factor(joined_tipping_data_anyilc_filter_ILC$subtype, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_ILC$stage <- factor(joined_tipping_data_anyilc_filter_ILC$stage, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_ILC$grade <- factor(joined_tipping_data_anyilc_filter_ILC$grade, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_ILC$anyilc <- factor(joined_tipping_data_anyilc_filter_ILC$anyilc, levels=c(0,1))

fit7 <- lm(ctc_cont ~ ctcmethodclean, data=joined_tipping_data_anyilc_filter_ILC)
tab_model(fit7, show.se = TRUE, show.std = TRUE, show.stat = TRUE)


fit8 <- lm(ctc_cont ~ ctcmethodclean, data=joined_tipping_data_anyilc_filter_IDC)
tab_model(fit8, show.se = TRUE, show.std = TRUE, show.stat = TRUE)
```

```{r}
#Survival by anyilc in IE/FC
f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc , data = joined_tipping_data_anyilc_filter_IE_FC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)



```

```{r}
#Survival by anyilc in cellsearch

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_CS)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_CS)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_CS)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
# Survival in ILC in IE/FC methos 0.45 cutpoint 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(anyilc == 1)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```


```{r}
# Survival in IDC in IE/FC methos 0.45 cutpoint 

joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(anyilc == 0)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
# Survival in ILC in CellSearch  method 0.45 cutpoint 

joined_tipping_data_anyilc_filter_CS_ILC <- joined_tipping_data_anyilc_filter_CS %>%
   filter(anyilc == 1)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_CS_ILC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
# Survival in IDC in CellSearch  method 0.45 cutpoint 

joined_tipping_data_anyilc_filter_CS_IDC <- joined_tipping_data_anyilc_filter_CS %>%
   filter(anyilc == 0)

#*Recurrence free survival*/


f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_CS_IDC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,12),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_CS_IDC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,12),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ highctc, data = joined_tipping_data_anyilc_filter_CS_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
# Cox Proportional-Hazards Model by method 

#stcox ctc_cont age i.stage  i.grade i.subtype if anyilc==0
#stcox highctc##i.anyilc age i.stage  i.grade i.subtype 


joined_tipping_data_anyilc_filter_IE_FC$anyilc <- factor(joined_tipping_data_anyilc_filter_IE_FC$anyilc, levels=c(0,1))

joined_tipping_data_anyilc_filter_IE_FC$anyilc

  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
  
  
    coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_cont + anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC)
summary(res.cox)



  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS)
summary(res.cox)

# Cox Proportional-Hazards Model by method in ILC


  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
    coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  

    
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)
summary(res.cox)


  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS_ILC)
summary(res.cox)

# Cox Proportional-Hazards Model by method in IDC


  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont  + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)
summary(res.cox)


  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS_IDC)
summary(res.cox)
```

```{r}
# Cox Proportional-Hazards Model : add method as a covariate 



  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ctcmethod + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ctcmethod + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter)
summary(res.cox)



  coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ctcmethod  + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ctcmethod + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_ILC)
summary(res.cox)

 coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ctcmethod  + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ctcmethod + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IDC)
summary(res.cox)

```

```{r}
#Survival by in ILC by subtype

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
#Survival by in IDC by subtype

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
#Survival by in ILC by subtype

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_CS_ILC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
#Survival by in IDC by subtype

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_CS_IDC)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_CS_IDC)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ subtype, data = joined_tipping_data_anyilc_filter_CS_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
#Survival by histology in subtype 1 

joined_tipping_data_anyilc_filter_IE_FC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(subtype == 1) 

   

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub1)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub1)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
joined_tipping_data_anyilc_filter_IE_FC_Sub2 <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(subtype == 2) 

   

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub2)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub2,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub2)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub2,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub2)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub2,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
joined_tipping_data_anyilc_filter_IE_FC_Sub3 <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(subtype == 3) 

   

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub3)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub3,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub3)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub3,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_IE_FC_Sub3)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_Sub3,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
# repeat CS method for Sub1 only to compare to IE/FC method Sub1 only 


joined_tipping_data_anyilc_filter_CS_Sub1 <- joined_tipping_data_anyilc_filter %>%
   filter(ctcmethod == "CellSearch") %>%
   filter(subtype == 1) 

f1 <- survfit(Surv(time_rfs, anyrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_CS_Sub1)
names(f1)

ggsurvplot(
   f1,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#*Distant Recurrence free survival*/
f2 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_CS_Sub1)

ggsurvplot(
   f2,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#Breast cancer specific survival
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_CS_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```

```{r}
#cox for IE/FC Sub1 only 


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)
summary(res.cox)


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc, data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)
summary(res.cox)

#cox for IE/FC ILC univariate  


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)
summary(res.cox)

#cox for IE/FC ILC univariate Sub1

joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
   filter(subtype == 1)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)
summary(res.cox)


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC_Sub1)
summary(res.cox)

#cox for IE/FC ILC multivariate Sub1


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)
summary(res.cox)


#cox for IE/FC ILC univariate ILC

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#multi 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#cox for IE/FC ILC univariate IDC

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#multi 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#cox for IE/FC ILC univariate ILC 

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#multi 

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
 
coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#cox for IE/FC ILC univariate IDC 

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#multi 

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtc_cont + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)
summary(res.cox)



#cox for IE/FC  univariate 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC)
summary(res.cox)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc , data =  joined_tipping_data_anyilc_filter_IE_FC)
summary(res.cox)

```

```{r}
#plot ctc 
library(devtools)
install_github("kassambara/easyGgplot2")
library(easyGgplot2)

# IE/FC vs Cell search 
# IDC vs ILC 
ggplot2.histogram(data=joined_tipping_data_anyilc_filter_CS, xName='ctc_cont',
        groupName='anyilc', legendPosition="top",
        alpha=0.5 )

table(joined_tipping_data_anyilc_filter_IE_FC$ctc_cont)

library(scales)


#plot ditribution of ctc count


library(ggplot2)
library(dplyr)
library(hrbrthemes)

hist.labs <- c("IDC","ILC")

ggplot(joined_tipping_data_anyilc_filter_CS, aes(x = ctc_cont)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(anyilc ~ .) +xlab("CTC count")


ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(x = ctc_cont)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(anyilc ~ .) +xlab("CTC count")


ggplot(joined_tipping_data_anyilc_filter_IE_FC_Sub1, aes(x = ctc_cont)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(anyilc ~ .) +xlab("CTC count")


ggplot(joined_tipping_data_anyilc_filter_CS_Sub1, aes(x = ctc_cont)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(anyilc ~ .) +xlab("CTC count")


ggplot(joined_tipping_data_anyilc_filter_ILC, aes(x = ctc_cont)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(ctcmethod ~ .) +xlab("CTC count")

ggplot(joined_tipping_data_anyilc_filter_IDC, aes(x = ctc_cont)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(ctcmethod ~ .) +xlab("CTC count")

#log CTC

joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   mutate(hist = case_when(
  anyilc == 0  ~ "IDC",
  anyilc == 1 ~ "ILC"))

ggplot(joined_tipping_data_anyilc_filter_ILC, aes(x = logctc)) +
  geom_histogram(fill = "white", colour = "black", binwidth = 0.2) +
  facet_grid(ctcmethod ~ .) +xlab("CTC count") + scale_x_continuous(breaks = seq(-2,2.5,0.2))

ggplot(joined_tipping_data_anyilc_filter_IDC, aes(x = logctc)) +
  geom_histogram(fill = "white", colour = "black", binwidth = 0.2) +
  facet_grid(ctcmethod ~ .) +xlab("CTC count") + scale_x_continuous(breaks = seq(-2,2.5,0.2))

joined_tipping_data_anyilc_filter <- joined_tipping_data_anyilc_filter %>%
   mutate(logctc = log(ctc_cont,10))

ggplot(joined_tipping_data_anyilc_filter, aes(x = logctc)) +
  geom_histogram(fill = "white", colour = "black", binwidth = 0.2) +
  facet_grid(ctcmethod ~ .) +xlab("CTC count") + scale_x_continuous(breaks = seq(-2,2.5,0.2))

joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(logctc = log(ctc_cont,10))

joined_tipping_data_anyilc_filter_CS <- joined_tipping_data_anyilc_filter_CS %>%
   mutate(logctc = log(ctc_cont,10))


joined_tipping_data_anyilc_filter_IE_FC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   mutate(logctc = log(ctc_cont,10))

joined_tipping_data_anyilc_filter_IE_FC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   mutate(hist = case_when(
  anyilc == 0  ~ "IDC",
 anyilc == 1 ~ "ILC"))


joined_tipping_data_anyilc_filter_IE_FC_neo$hist

   ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-2,2.5,0.2)) + xlab("1+ Log CTCs/mL") 
   
    ggplot(joined_tipping_data_anyilc_filter_IE_FC_neo, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-2,2.5,0.2)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(logctc, fill = hist)) + 
   geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity') + theme_bw() + scale_x_continuous(breaks = seq(-2,2.5,0.2)) + xlab("Log CTCs/mL")

ggplot(joined_tipping_data_anyilc_filter_IE_FC_neo, aes(logctc, fill = anyilc)) + 
   geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity') + theme_bw() + scale_x_continuous(breaks = seq(-2,2.5,0.2)) + xlab("Log CTCs/mL")

joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(pluslogctc = 1 + logctc)

joined_tipping_data_anyilc_filter_IE_FC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   mutate(pluslogctc = 1 + logctc)

joined_tipping_data_anyilc_filter_CS <- joined_tipping_data_anyilc_filter_CS %>%
   mutate(pluslogctc = 1 + logctc)

ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(pluslogctc, fill = hist)) + geom_histogram(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.0,2.5,0.5)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + geom_histogram(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-2,5.5,0.5)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_neo, aes(pluslogctc, fill = anyilc)) + geom_density(alpha = 0.2) + geom_histogram(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-2,5.5,0.5)) + xlab("1+ Log CTCs/mL") 


#plots used for presentation CTC and DTC distribution 


joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(logdtc = log(dtc_cont,10))

joined_tipping_data_anyilc_filter_IE_FC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   mutate(logdtc = log(dtc_cont,10))


joined_tipping_data_anyilc_filter_IE_FC <- joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(pluslogdtc = 1 + logdtc)

joined_tipping_data_anyilc_filter_IE_FC_neo <- joined_tipping_data_anyilc_filter_IE_FC_neo %>%
   mutate(pluslogdtc = 1 + logdtc)

joined_tipping_data_anyilc_filter_CS <- joined_tipping_data_anyilc_filter_CS %>%
   mutate(logdtc = log(dtc_cont,10))

joined_tipping_data_anyilc_filter_CS <- joined_tipping_data_anyilc_filter_CS %>%
   mutate(pluslogdtc = 1 + logdtc)

ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(pluslogdtc, fill = hist)) + geom_histogram(alpha = 0.8) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 


ggplot(joined_tipping_data_anyilc_filter_IE_FC_neo, aes(pluslogdtc, fill = hist)) + geom_histogram(alpha = 0.8) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 


ggplot(joined_tipping_data_anyilc_filter_IE_FC_neo, aes(pluslogdtc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 



ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(pluslogdtc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 


ggplot(joined_tipping_data_anyilc_filter_CS, aes(pluslogdtc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_Stage1, aes(pluslogdtc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_Stage2, aes(pluslogdtc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_Stage3, aes(pluslogdtc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(0.2,5.2,0.2)) + xlab("1+ Log DTCs/mL") 


ggplot(joined_tipping_data_anyilc_filter_IE_FC, aes(pluslogctc, fill = hist)) + geom_histogram(alpha = 0.8) + theme_bw() + scale_x_continuous(breaks = seq(-4,5.5,0.2)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_neo, aes(pluslogctc, fill = anyilc)) + geom_histogram(alpha = 0.8) + theme_bw() + scale_x_continuous(breaks = seq(-4,5.5,0.2)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_CS, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-4,5.5,0.2)) + xlab("1+ Log CTCs/mL") 


joined_tipping_data_anyilc_filter_IE_FC_Stage1 <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(stage == 1) #196 patients 
joined_tipping_data_anyilc_filter_IE_FC_Stage2 <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(stage == 2) #58 patients 
joined_tipping_data_anyilc_filter_IE_FC_Stage3 <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(stage == 3) #27

ggplot(joined_tipping_data_anyilc_filter_IE_FC_Stage1, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-4,5.5,0.2)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_Stage2, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-4,5.5,0.2)) + xlab("1+ Log CTCs/mL") 

ggplot(joined_tipping_data_anyilc_filter_IE_FC_Stage3, aes(pluslogctc, fill = hist)) + geom_density(alpha = 0.2) + theme_bw() + scale_x_continuous(breaks = seq(-4,5.5,0.2)) + xlab("1+ Log CTCs/mL") 

# mosaic plot

library(vcd)


mosaic( ~ hist + ctccut , data = joined_tipping_data_anyilc_filter_IE_FC,  highlighting = "ctccut", highlighting_fill = c("lightblue", "pink"))

  
```

```{r}
#DTC comparison

joined_tipping_data_anyilc_filter%>%
  select(anyilc, dtc_cont,ageatdx, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter%>%
   select(dtc_cont, ctcmethodclean) %>%
   filter(ctcmethodclean == 1 | ctcmethodclean == 2) %>%
  tbl_summary(by = ctcmethodclean, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_ILC%>%
  select(dtc_cont, ctcmethodclean) %>%
   filter(ctcmethodclean == 1 | ctcmethodclean == 2) %>%
  tbl_summary(by = ctcmethodclean, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_IDC%>%
  select(dtc_cont, ctcmethodclean) %>%
   filter(ctcmethodclean == 1 | ctcmethodclean == 2) %>%
  tbl_summary(by = ctcmethodclean, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_IE_FC%>%
  select(anyilc, dtc_cont) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_IE_FC_Sub1%>%
  select(anyilc, dtc_cont) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

#noneo
joined_tipping_data_anyilc_filter_IE_FC%>%
  select(anyilc, dtc_cont,age, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_CS%>%
  select(anyilc, dtc_cont) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_CS%>%
  select(anyilc, dtc_cont,ageatdx, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

# DTC comparison by lm 

library(sjPlot)

#ctcmethodclean
fit1 <- lm(dtc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit1)

fit1 <- lm(dtc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_IE_FC_Sub1)
tab_model(fit1)

fit2 <- lm(dtc_cont ~ anyilc + stage + subtype + grade + ageatdx, data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit2)

fit2 <- lm(dtc_cont ~ anyilc + stage + subtype + grade + ageatdx, data=joined_tipping_data_anyilc_filter_IE_FC_Sub1)
tab_model(fit2)


fit1 <- lm(dtc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_CS)
tab_model(fit1, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit2 <- lm(dtc_cont ~ anyilc + stage + subtype + grade + ageatdx, data=joined_tipping_data_anyilc_filter_CS)
tab_model(fit2, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit6 <- lm(dtc_cont ~ ctcmethodclean, data=joined_tipping_data_anyilc_filter_ILC)
tab_model(fit6, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit6 <- lm(dtc_cont ~ ctcmethodclean, data=joined_tipping_data_anyilc_filter_IDC)
tab_model(fit6, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

#fit5 <- lm(dtc_cont ~ anyilc + ctcmethodclean, data=joined_tipping_data_anyilc_filter)
#tab_model(fit5, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

# COX model

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)
summary(res.cox)


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)
summary(res.cox)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)
summary(res.cox)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
res.cox <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)
summary(res.cox)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_CS_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_CS_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#IDC DTC 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
  
coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtc_cont + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#DTC survival 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
   filter(!is.na(dtc_cont)) 

mean(joined_tipping_data_anyilc_filter_IE_FC_ILC$dtc_cont) #20.51
median(joined_tipping_data_anyilc_filter_IE_FC_ILC$dtc_cont) #8.14

mean(joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1$dtc_cont) #21.61
median(joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1$dtc_cont) #9.61

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(dtccut = case_when(
  dtc_cont  < 8.14  ~ 0,
  dtc_cont >= 8.14 ~ 1))

joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
     mutate(dtccut = case_when(
  dtc_cont  < 21.61  ~ 0,
  dtc_cont >= 21.61 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
       palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + age + stage + grade +subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
        palette = c("#E7B800", "#2E9FDF"), # custom color palette
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)


coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + age + stage + grade +subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

joined_tipping_data_anyilc_filter_CS_ILC <- joined_tipping_data_anyilc_filter_CS_ILC %>%
   filter(!is.na(dtc_cont)) 

mean(joined_tipping_data_anyilc_filter_CS_ILC$dtc_cont) #12.28
median(joined_tipping_data_anyilc_filter_CS_ILC$dtc_cont) #9.94

joined_tipping_data_anyilc_filter_CS_ILC <- joined_tipping_data_anyilc_filter_CS_ILC %>%
     mutate(dtccut = case_when(
  dtc_cont  < 9.94  ~ 0,
  dtc_cont >= 9.94 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
#IE/FC Sub1


joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
   filter(!is.na(dtc_cont)) 

mean(joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1$dtc_cont) #21.61
median(joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1$dtc_cont) #9.61

joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
     mutate(dtccut = case_when(
  dtc_cont  < 21.61  ~ 0,
  dtc_cont >= 21.61 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

joined_tipping_data_anyilc_filter_CS_ILC_Sub1 <- joined_tipping_data_anyilc_filter_CS_ILC %>%
  filter(subtype == 1)

mean(joined_tipping_data_anyilc_filter_CS_ILC_Sub1$dtc_cont) #12.39
median(joined_tipping_data_anyilc_filter_CS_ILC_Sub1$dtc_cont) #9.93

joined_tipping_data_anyilc_filter_CS_ILC_Sub1 <- joined_tipping_data_anyilc_filter_CS_ILC_Sub1 %>%
     mutate(dtccut = case_when(
  dtc_cont  < 9.93  ~ 0,
  dtc_cont >= 9.93 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_CS_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#COX 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(dtccut = case_when(
  dtc_cont  < 16.78  ~ 0,
  dtc_cont >= 16.78 ~ 1))

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
     mutate(dtccut = case_when(
  dtc_cont  < 16.78  ~ 0,
  dtc_cont >= 16.78 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut  , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut+ ageatdx + stage + grade   , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
```

```{r}
#CTC tables/figures for presentation

joined_tipping_data_anyilc_filter_IE_FC %>%
   mutate(hist = case_when(
  anyilc == 0  ~ "IDC",
  anyilc == 1 ~ "ILC"))

#compare detection methods and histology

joined_tipping_data_anyilc_filter_IE_FC %>%
  select(ctc_cont, anyilc) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_IE_FC_Sub1 %>%
  select(ctc_cont, anyilc) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_CS %>%
  select(ctc_cont, anyilc) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter %>%
  select(anyilc, ageatdx, subtype, stage, grade) %>%
  tbl_summary(by = anyilc, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter %>%
  select(ctc_cont, ctcmethodclean) %>%
   filter(ctcmethodclean == 1 | ctcmethodclean == 2) %>%
  tbl_summary(by = ctcmethodclean, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_ILC %>%
  select(ctc_cont, ctcmethodclean) %>%
   filter(ctcmethodclean == 1 | ctcmethodclean == 2) %>%
  tbl_summary(by = ctcmethodclean, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_IDC %>%
  select(ctc_cont, ctcmethodclean) %>%
   filter(ctcmethodclean == 1 | ctcmethodclean == 2) %>%
  tbl_summary(by = ctcmethodclean, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


#CTC prediction

fit2 <- lm(ctc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_CS)
tab_model(fit2)

fit2 <- lm(ctc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_CS_Sub1)
tab_model(fit2)

fit3 <- lm(ctc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit3)

fit3 <- lm(ctc_cont ~ anyilc, data=joined_tipping_data_anyilc_filter_IE_FC_Sub1)
tab_model(fit3)

fit3 <- lm(ctc_cont ~ anyilc + stage + subtype + grade + age , data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit3, show.reflvl = TRUE)
summary(fit3)

fit3 <- lm(dtc_cont ~ anyilc + stage + subtype + grade + age , data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit3, show.reflvl = TRUE)
summary(fit3)

fit3 <- lm(dtc_cont ~ anyilc , data=joined_tipping_data_anyilc_filter_IE_FC)
tab_model(fit3, show.reflvl = TRUE)
summary(fit3)


fit3 <- lm(ctc_cont ~ anyilc + stage + subtype + grade + ageatdx , data=joined_tipping_data_anyilc_filter_IE_FC_Sub1)
tab_model(fit3)

fit4 <- lm(ctc_cont ~ ctcmethodclean, data=joined_tipping_data_anyilc_filter)
tab_model(fit4, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

#Breast cancer specific survival 

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

joined_tipping_data_anyilc_filter_Sub1 <- joined_tipping_data_anyilc_filter %>%
   filter(subtype == 1)

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ anyilc, data = joined_tipping_data_anyilc_filter_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#cutpoint survival

joined_tipping_data_anyilc_filter <- joined_tipping_data_anyilc_filter %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.45  ~ 0,
  ctc_cont >= 0.45 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data =  joined_tipping_data_anyilc_filter_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

joined_tipping_data_anyilc_filter_ILC <- joined_tipping_data_anyilc_filter_ILC %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.21 ~ 0,
  ctc_cont >= 0.21 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data =  joined_tipping_data_anyilc_filter_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS
f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

joined_tipping_data_anyilc_filter_ILC_Sub1 <- joined_tipping_data_anyilc_filter_ILC %>%
   filter(subtype == 1)

joined_tipping_data_anyilc_filter_ILC_Sub1 <- joined_tipping_data_anyilc_filter_ILC_Sub1 %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.44  ~ 0,
  ctc_cont >= 0.44 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

mean(joined_tipping_data_anyilc_filter_IE_FC_ILC$ctc_cont) #2.11
median(joined_tipping_data_anyilc_filter_IE_FC_ILC$ctc_cont) #0.44

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.265 ~ 0,
  ctc_cont >= 0.265 ~ 1))

 
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,  
    conf.int = FALSE,# show p-value of log-rank test.
   palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)



coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype



#combine means from IE/FC and CS

#mean for IE/FC is 2.11 
mean(joined_tipping_data_anyilc_filter_CS_ILC$ctc_cont) #0.053

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(ctccut = case_when(
  ctc_cont  < 1.08  ~ 0,
  ctc_cont >= 1.08 ~ 1))


f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


#DRFS
joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.44  ~ 0,
  ctc_cont >= 0.44 ~ 1))

table(joined_tipping_data_anyilc_filter_IE_FC_ILC$ctccut)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,
   palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)



coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

mean(joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1$ctc_cont) #1.71
median(joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1$ctc_cont) #0.43

joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.44  ~ 0,
  ctc_cont >= 0.44 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + ageatdx + stage + grade, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

mean(joined_tipping_data_anyilc_filter_CS_ILC$ctc_cont) #0.05
median(joined_tipping_data_anyilc_filter_CS_ILC$ctc_cont) #0

joined_tipping_data_anyilc_filter_CS_ILC <- joined_tipping_data_anyilc_filter_CS_ILC %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.09 ~ 0,
  ctc_cont >= 0.09 ~ 1))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_CS_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#DRFS
f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_CS_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_CS_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


joined_tipping_data_anyilc_filter_CS_ILC_Sub1 <- joined_tipping_data_anyilc_filter_CS_ILC %>%
   filter(subtype == 1)

joined_tipping_data_anyilc_filter_CS_ILC_Sub1 <- joined_tipping_data_anyilc_filter_CS_ILC_Sub1 %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.047  ~ 0,
  ctc_cont >= 0.047 ~ 1))

mean(joined_tipping_data_anyilc_filter_CS_ILC_Sub1$ctc_cont) #0.047
median(joined_tipping_data_anyilc_filter_CS_ILC_Sub1$ctc_cont) #0

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_CS_ILC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_CS_ILC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,10),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 2,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

#follow up analysis 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctc_cont , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype



```

```{r}
#Our relatively small sample size of ILC patients propelled combining the CTC and DTC counts to overcome the statistical underpowering limitation and detect clinically relevant prognostic difference among ILC pts. 

#DTC+/CTC+ survival 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(combcut = case_when(
  dtc_cont  < 8.14 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 8.14 & ctc_cont >= 0.44 ~ "CTC+/DTC+",
  dtc_cont >= 8.14 & ctc_cont < 0.44 ~ "CTC-/DTC+",
  dtc_cont  < 8.14 & ctc_cont >= 0.44 ~ "CTC+/DTC-"))

joined_tipping_data_anyilc_filter_IE_FC_ILC$combcut

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(combcut = case_when(
  dtc_cont  < 8.14 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 8.14 & ctc_cont >= 0.44 ~ "CTC+/DTC+"))
#change dtc to 8.14 (median)
f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE,
 tables.theme = theme_cleantable()# show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut+ ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE,
  tables.theme = theme_cleantable()# show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut  , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxmodel <- coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  
summary(coxmodel)

joined_tipping_data_anyilc_filter_IE_FC_ILC$subtype <- factor(joined_tipping_data_anyilc_filter_IE_FC_ILC$subtype, levels=c(1,2,3))
joined_tipping_data_anyilc_filter_IE_FC_ILC$subtype

joined_tipping_data_anyilc_filter_IE_FC_ILC$grade <- factor(joined_tipping_data_anyilc_filter_IE_FC_ILC$grade, levels=c(1,2,3))
joined_tipping_data_anyilc_filter_IE_FC_ILC$grade

joined_tipping_data_anyilc_filter_IE_FC_ILC$stage <- factor(joined_tipping_data_anyilc_filter_IE_FC_ILC$stage, levels=c(1,2,3))
joined_tipping_data_anyilc_filter_IE_FC_ILC$stage


joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
     mutate(combcut = case_when(
  dtc_cont  < 21.61 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 21.61 & ctc_cont >= 0.44 ~ "CTC+/DTC+",
  dtc_cont >= 21.61 & ctc_cont < 0.44 ~ "CTC-/DTC+",
  dtc_cont  < 21.61 & ctc_cont >= 0.44 ~ "CTC+/DTC-"))

joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1 %>%
     mutate(combcut = case_when(
  dtc_cont  < 21.61 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 21.61 & ctc_cont >= 0.44 ~ "CTC+/DTC+"))

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


```

```{r}
# CTC in IDC in IE/FC analysis 

mean(joined_tipping_data_anyilc_filter_IE_FC_IDC$ctc_cont) #0.71
median(joined_tipping_data_anyilc_filter_IE_FC_IDC$ctc_cont) #0.29

joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
   mutate(ctccut = case_when(
  ctc_cont  < 0.49 ~ "CTC-",
  ctc_cont >= 0.49 ~ "CTC+"))

joined_tipping_data_anyilc_filter_IE_FC_IDC$ctccut

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
  palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut + age + stage + grade + subtype  , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
   mutate(ctccut = case_when(
  ctc_cont  < 0.59 ~ "CTC-",
  ctc_cont >= 0.59 ~ "CTC+"))

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
   palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)
coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + age + stage + grade + subtype  , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

# CTC in IDC in IE/FC analysis for subtype 1 

joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
   filter(subtype == 1)

joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1 %>%
   mutate(ctccut = case_when(
  ctc_cont  < 0.35 ~ "CTC-",
  ctc_cont >= 0.35 ~ "CTC+"))

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut+ ageatdx + stage + grade   , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1 %>%
   mutate(ctccut = case_when(
  ctc_cont  < 0.59 ~ "CTC-",
  ctc_cont >= 0.59 ~ "CTC+"))

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + ageatdx + stage + grade + subtype   , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


```

```{r}
# DTC in IDC IE/FC analysis 
 
joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
 filter(!is.na(dtc_cont))

mean(joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$dtc_cont) #15.51

median(joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$dtc_cont) #7.01

joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
   mutate(dtccut = case_when(
  dtc_cont  < 8.46 ~ "DTC-",
  dtc_cont >= 8.46 ~ "DTC+"))

joined_tipping_data_anyilc_filter_IE_FC_IDC$dtccut

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC %>%
   mutate(dtccut = case_when(
  dtc_cont  < 8.46 ~ "DTC-",
  dtc_cont >= 8.46 ~ "DTC+"))

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + ageatdx + stage + grade + subtype   , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC %>%
   mutate(dtccut = case_when(
  dtc_cont  < 13.83 ~ "DTC-",
  dtc_cont >= 13.83 ~ "DTC+"))

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + ageatdx + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut , data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC %>%
   filter(subtype == 1)

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 %>%
   mutate(dtccut = case_when(
  dtc_cont  < 15.72 ~ "DTC-",
  dtc_cont >= 15.72 ~ "DTC+"))

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)


joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 %>%
   mutate(dtccut = case_when(
  dtc_cont  < 4.75 ~ "DTC-",
  dtc_cont >= 4.75 ~ "DTC+"))

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut  , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut , data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)



```

```{r}
#DTC+/CTC+ survival in IDC IE/FC



joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC %>%
     mutate(combcut = case_when(
  dtc_cont  < 18.61 & ctc_cont < 0.49 ~ "CTC-/DTC-",
  dtc_cont >= 18.61 & ctc_cont >= 0.49 ~ "CTC+/DTC+",
  dtc_cont >= 18.61 | dtc_cont < 18.61 & ctc_cont < 0.49 | ctc_cont >= 0.49 ~ "CTC-/DTC+ and CTC+/DTC-"))

with(joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC, table(combcut))


f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE,
   tables.theme = theme_cleantable()# show bars instead of names in text annotations
                            # in legend of risk table
)
# show bars instead of names in text annotations
                            # in legend of risk table


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut + ageatdx + stage + grade + subtype,  data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut , data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE,
   tables.theme = theme_cleantable()# show bars instead of names in text annotations
                            # in legend of risk table
)
# show bars instead of names in text annotations
                            # in legend of risk table

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1 %>%
    mutate(combcut = case_when(
  dtc_cont  < 15.72 & ctc_cont < 0.35 ~ "CTC-/DTC-",
  dtc_cont >= 15.72 & ctc_cont >= 0.35 ~ "CTC+/DTC+"))


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC_Sub1)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#(ILC: 0.44 CTCs/mL [optimal cutoff], 20.51 DTCs/mL [median]; IDC: 0.49 CTCs/mL [optimal cutoff], 8.46 DTCs/mL [optimal cutoff]). 
```

```{r}
# ILC CTC high in the shoulder of density plot

joined_tipping_data_anyilc_filter_IE_FC_ILC_density <- joined_tipping_data_anyilc_filter_IE_FC %>%
   filter(anyilc == 1)

joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high <- joined_tipping_data_anyilc_filter_IE_FC_ILC_density %>%
   filter(logctc >= 0.5 & logctc < 1.6)

#9/61 = 14.75% of patients are in that shoulder 
library(gtsummary)

joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high%>%
  select(ctc_cont,stage) %>%
  tbl_summary(by = stage, statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     anyilc,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

library("ggpubr")
ggboxplot(joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high, x = "stage", y = "ctc_cont", 
          color = "stage", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3"),
          ylab = "CTC count", xlab = "Stage")
 
# Visualize: Specify the comparisons you want
my_comparisons <- list( c("1", "2"), c("1", "3"), c("2", "3") )
ggboxplot(joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high, x = "stage", y = "ctc_cont",
          color = "stage", palette = "jco")+ 
  stat_compare_means(comparisons = my_comparisons)+ # Add pairwise comparisons p-value
  stat_compare_means(label.y = 2)  

compare_means(ctc_cont ~ stage,  data = joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high,
              method = "t.test")

res.aov <- aov(ctc_cont ~ stage, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high)
# Summary of the analysis
summary(res.aov)


t.test(joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high$ctc_cont~joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high$nodesbinary)


p <- ggboxplot(joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high, x = "stage", y = "ctc_cont",
               color = "stage", palette =c("#0000FF", "#E7B800", "009999"),
               add = "boxplot")
my_comparisons <- list(c("1", "2"),c("1","3"),c("3","2"))
p + stat_compare_means(comparisons = my_comparisons, method = "t.test" ) # Add pairwise comparisons p-value
  
one.way <- aov(ctc_cont ~ stage, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high)

summary(one.way)

one.way <- aov(ctc_cont ~ nstage, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high)

summary(one.way)


one.way <- aov(ctc_cont ~ tstage, data = joined_tipping_data_anyilc_filter_IE_FC_ILC_density_high)

summary(one.way)

mean(joined_tipping_data_anyilc_filter_ILC$time_drfs)
```

```{r}
#re-evaluating DTC cutoff (Compared to paper) in both ILC and DTC then use the same cutoff in the separate cohorts 

joined_tipping_data_anyilc_filter_IE_FC_noDTCNA <- joined_tipping_data_anyilc_filter_IE_FC %>% 
   filter(!is.na(dtc_cont))

#15.72 is the new cutoff using both ILC and IDC cohorts 

#IDC cohort 

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC <- joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC %>%
   mutate(dtccut = case_when(
  dtc_cont  < 15.72 ~ "DTC-",
  dtc_cont >= 15.72 ~ "DTC+"))
#show levels of the covs

joined_tipping_data_anyilc_filter_IE_FC_IDC

joined_tipping_data_anyilc_filter_IE_FC_IDC$subtype <- factor(joined_tipping_data_anyilc_filter_IE_FC_IDC$subtype, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_IE_FC_IDC$grade <- factor(joined_tipping_data_anyilc_filter_IE_FC_IDC$grade, levels=c(1,2,3))

joined_tipping_data_anyilc_filter_IE_FC_IDC$stage <- factor(joined_tipping_data_anyilc_filter_IE_FC_IDC$stage, levels=c(1,2,3))

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + ageatdx + stage + grade + subtype   , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~  dtccut + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~  dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


#ILC cohort 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(dtccut = case_when(
  dtc_cont  < 18.61  ~ "DTC-",
  dtc_cont >= 18.61 ~ "DTC+"))


joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(dtccut = case_when(
  dtc_cont  < 15.72  ~ "DTC-",
  dtc_cont >= 15.72 ~ "DTC+"))
joined_tipping_data_anyilc_filter_IE_FC_ILC$dtccut

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~  dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~  dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
     palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)


f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
   palette = c("#E7B800", "#2E9FDF"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)


#DTC+/CTC+ survival with new dtc cutoff in ILC 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(combcut = case_when(
  dtc_cont  < 15.72 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 15.72 & ctc_cont >= 0.44 ~ "CTC+/DTC+",
  dtc_cont >= 15.72 & ctc_cont < 0.44 ~ "CTC-/DTC+",
  dtc_cont  < 15.72 & ctc_cont >= 0.44 ~ "CTC+/DTC-"))

joined_tipping_data_anyilc_filter_IE_FC_ILC$combcut

joined_tipping_data_anyilc_filter_IE_FC_ILC2 <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(combcut = case_when(
  dtc_cont  < 15.72 ~ "DTC-" ,
  ctc_cont < 0.44 ~ "CTC-",
  dtc_cont >= 15.72 ~ "DTC+" ,
  ctc_cont >= 0.44 ~ "CTC+"))

joined_tipping_data_anyilc_filter_IE_FC_ILC2$combcut

f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
       palette = c("#E7B800", "#2E9FDF", "dark red", "dark green"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)



coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut+ ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_ILC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_ILC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
      palette = c("#E7B800", "#2E9FDF", "dark red", "dark green"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut  , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


#18.61 is the paper cutoff using both ILC and IDC cohorts 

#IDC cohort    

joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
   mutate(dtccut = case_when(
  dtc_cont  < 8.46 ~ "DTC-",
  dtc_cont >= 8.46 ~ "DTC+"))



median(joined_tipping_data_anyilc_filter_IE_FC_IDC$dtc_cont)
#show levels of the covs

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$subtype <- factor(joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$subtype, levels=c(1,2,3))
joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$subtype

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$grade <- factor(joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$grade, levels=c(1,2,3))
joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$grade

joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$stage <- factor(joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$stage, levels=c(1,2,3))
joined_tipping_data_anyilc_filter_IE_FC_IDC_DTC$stage

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + age + stage + grade + subtype   , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~  dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~  dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


#ILC cohort 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(dtccut = case_when(
  dtc_cont  < 18.61  ~ "DTC-",
  dtc_cont >= 18.61 ~ "DTC+"))

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + ageatdx + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

#DTC+/CTC+ survival with paper dtc cutoff in ILC 

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(combcut = case_when(
  dtc_cont  < 18.61 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 18.61 & ctc_cont >= 0.44 ~ "CTC+/DTC+",
  dtc_cont >= 18.61 & ctc_cont < 0.44 ~ "CTC-/DTC+",
  dtc_cont  < 18.61 & ctc_cont >= 0.44 ~ "CTC+/DTC-"))

joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
     mutate(combcut = case_when(
  dtc_cont  < 8.46 & ctc_cont < 0.49 ~ "CTC-/DTC-",
  dtc_cont >= 8.46 & ctc_cont >= 0.49 ~ "CTC+/DTC+",
  dtc_cont >= 8.46 & ctc_cont < 0.49 ~ "CTC-/DTC+",
  dtc_cont  < 8.46 & ctc_cont >= 0.49 ~ "CTC+/DTC-"))

joined_tipping_data_anyilc_filter_IE_FC_IDC2 <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
     mutate(combcut = case_when(
  dtc_cont  < 8.46 ~ "DTC-" ,
  ctc_cont < 0.49 ~ "CTC-",
  dtc_cont >= 8.46 ~ "DTC+" ,
  ctc_cont >= 0.49 ~ "CTC+"))

(joined_tipping_data_anyilc_filter_IE_FC_IDC2$combcut)


f3 <- survfit(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
palette = c("#E7B800", "#2E9FDF", "dark red", "dark green"), # custom color palette
         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)


coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut+ age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

f3 <- survfit(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut, data = joined_tipping_data_anyilc_filter_IE_FC_IDC)

ggsurvplot(
   f3,                     # survfit object with calculated statistics.
   data = joined_tipping_data_anyilc_filter_IE_FC_IDC,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = FALSE,             # show p-value of log-rank test.
   conf.int = FALSE,         # show confidence intervals for 
    palette = c("#E7B800", "#2E9FDF", "dark red", "dark green"), # custom color palette
   xlim = c(0,15),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5, 
   legend = c(0.2, 0.4), # break X axis in time intervals by 500.
  # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
)


coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)


coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut  , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

table(joined_tipping_data_anyilc_filter_IE_FC_ILC$combcut)


#DTC+/CTC+ survival with paper dtc cutoff in ILC combine the mixed groups in one group

joined_tipping_data_anyilc_filter_IE_FC_ILC <- joined_tipping_data_anyilc_filter_IE_FC_ILC %>%
     mutate(combcut = case_when(
  dtc_cont  < 8.14 & ctc_cont < 0.44 ~ "CTC-/DTC-",
  dtc_cont >= 8.14 & ctc_cont >= 0.44 ~ "CTC+/DTC+",
  dtc_cont >= 8.14 | dtc_cont < 8.14 & ctc_cont < 0.44 | ctc_cont >= 0.44 ~ "CTC-/DTC+ and CTC+/DTC-"))

joined_tipping_data_anyilc_filter_IE_FC_IDC <- joined_tipping_data_anyilc_filter_IE_FC_IDC %>%
     mutate(combcut = case_when(
  dtc_cont  < 8.46 & ctc_cont < 0.49 ~ "CTC-/DTC-",
  dtc_cont >= 8.46 & ctc_cont >= 0.49 ~ "CTC+/DTC+",
  dtc_cont >= 8.46 | dtc_cont < 8.46 & ctc_cont < 0.49 | ctc_cont >= 0.49 ~ "CTC-/DTC+ and CTC+/DTC-"))

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut  , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)



coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC)  %>% 
  gtsummary::tbl_regression(exp = TRUE)

median(joined_tipping_data_anyilc_filter_IE_FC_IDC$time_drfs)
median(joined_tipping_data_anyilc_filter_IE_FC_IDC$time_os)

median(joined_tipping_data_anyilc_filter_IE_FC_ILC$time_drfs)
median(joined_tipping_data_anyilc_filter_IE_FC_ILC$time_os)

joined_tipping_data_anyilc_filter_IE_FC_ILC$ctccut
```

```{r}
#evaluate mean and median for ILC NEO IE/FC CTC
joined_tipping_data_anyilc_filter_IE_FC_ILC_neo<- joined_tipping_data_anyilc_filter_IE_FC_ILC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.135  ~ 0,
  ctc_cont >= 0.135 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#evaluate mean and median for ILC NEO CS
joined_tipping_data_anyilc_filter_CS_ILC_neo<- joined_tipping_data_anyilc_filter_CS_ILC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.08  ~ 0,
  ctc_cont >= 0.08 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype


```

```{r}
#evaluate mean and median for ILC NEO IE/FC DTC

mean(joined_tipping_data_anyilc_filter_IE_FC_ILC_neo$dtc_cont) #11.15
median(joined_tipping_data_anyilc_filter_IE_FC_ILC_neo$dtc_cont) #8.71


joined_tipping_data_anyilc_filter_IE_FC_ILC_neo<- joined_tipping_data_anyilc_filter_IE_FC_ILC_neo %>%
     mutate(dtccut = case_when(
  dtc_cont  < 8.71  ~ 0,
  dtc_cont >= 8.71 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ age + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut  , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#evaluate mean and median for ILC NEO CS

summary(joined_tipping_data_anyilc_filter_CS_ILC_neo)
#dtc mean = 16.91
#dtc median = 9.56
joined_tipping_data_anyilc_filter_CS_ILC_neo<- joined_tipping_data_anyilc_filter_CS_ILC_neo %>%
     mutate(dtccut = case_when(
  dtc_cont  < 9.56  ~ 0,
  dtc_cont >= 9.56 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

   coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
     gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype
```

```{r}
#COMPARE COUNTS BY HOSTOLOGY 


fit <- lm(ctc_cont ~ anyilc + stage + subtype + grade + age, data=joined_tipping_data_anyilc_filter_IE_FC_neo)
summary(fit)
tab_model(fit, show.se = TRUE, show.std = TRUE, show.stat = TRUE)

fit <- lm(ctc_cont ~ anyilc + stage + subtype + grade + age, data=joined_tipping_data_anyilc_filter_IE_FC_neo)


      
      t.test(joined_tipping_data_anyilc_filter_IE_FC_neo$ctc_cont~joined_tipping_data_anyilc_filter_IE_FC_neo$anyilc)

fit <- lm(ctc_cont ~ anyilc + stage + subtype + grade + age, data=joined_tipping_data_anyilc_filter_CS_neo)

summary(fit)

t.test(joined_tipping_data_anyilc_filter_CS_neo$ctc_cont~joined_tipping_data_anyilc_filter_CS_neo$anyilc)


    
      t.test(joined_tipping_data_anyilc_filter_IE_FC_neo$dtc_cont~joined_tipping_data_anyilc_filter_IE_FC_neo$anyilc)
      
      fit <- lm(dtc_cont ~ anyilc + stage + subtype + grade + age, data=joined_tipping_data_anyilc_filter_IE_FC_neo)
      summary(fit)


fit <- lm(dtc_cont ~ anyilc + stage + subtype + grade + age, data=joined_tipping_data_anyilc_filter_CS_neo)

summary(fit)

t.test(joined_tipping_data_anyilc_filter_CS_neo$dtc_cont~joined_tipping_data_anyilc_filter_CS_neo$anyilc)
```


```{r}
#evaluate OPTIMIZED CUTOFF ILC NEO IE/FC CTC
joined_tipping_data_anyilc_filter_IE_FC_ILC_neo<- joined_tipping_data_anyilc_filter_IE_FC_ILC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.32  ~ 0,
  ctc_cont >= 0.32 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#evaluate OPTIMIZED CUTOFF ILC NEO CS

joined_tipping_data_anyilc_filter_CS_ILC_neo<- joined_tipping_data_anyilc_filter_CS_ILC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.13  ~ 0,
  ctc_cont >= 0.13 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
```


```{r}
#evaluate OPTIMIZED CUTOFF ILC NEO IE/FC DTC
joined_tipping_data_anyilc_filter_IE_FC_ILC_neo<- joined_tipping_data_anyilc_filter_IE_FC_ILC_neo %>%
     mutate(dtccut = case_when(
  dtc_cont  < 14.64  ~ 0,
  dtc_cont >= 14.64 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#evaluate OPTIMIZED CUTOFF ILC NEO CS

joined_tipping_data_anyilc_filter_CS_ILC_neo<- joined_tipping_data_anyilc_filter_CS_ILC_neo %>%
     mutate(dtccut = case_when(
  dtc_cont  < 3.88  ~ 0,
  dtc_cont >= 3.88 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut+ age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#
#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype
```


```{r}
#evaluate mean and median for IDC NEO IE/FC CTC

summary(joined_tipping_data_anyilc_filter_IE_FC_IDC_neo)
#median ctc = 0.2 mean ctc = 1.057
joined_tipping_data_anyilc_filter_IE_FC_IDC_neo<- joined_tipping_data_anyilc_filter_IE_FC_IDC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 1.057  ~ 0,
  ctc_cont >= 1.057 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ age + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ age + stage + grade + subtype


#evaluate mean and median for IDC NEO CS
summary(joined_tipping_data_anyilc_filter_CS_IDC_neo)
#mean ctc = 0.082 meidan ctc = 0
joined_tipping_data_anyilc_filter_CS_IDC_neo<- joined_tipping_data_anyilc_filter_CS_IDC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.082  ~ 0,
  ctc_cont >= 0.082 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_CS_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut  , data =  joined_tipping_data_anyilc_filter_CS_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype
```


```{r}
#evaluate mean and median for IDC NEO IE/FC DTC

summary(joined_tipping_data_anyilc_filter_IE_FC_IDC_neo)
#mean dtc = 19.6 median dtc = 8.6


joined_tipping_data_anyilc_filter_IE_FC_IDC_neo<- joined_tipping_data_anyilc_filter_IE_FC_IDC_neo %>%
     mutate(dtccut = case_when(
  dtc_cont  < 8.6  ~ 0,
  dtc_cont >= 8.6 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ age + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut + age + stage + grade + subtype , data =  joined_tipping_data_anyilc_filter_IE_FC_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#evaluate mean and median for IDC NEO CS

summary(joined_tipping_data_anyilc_filter_CS_IDC_neo)
#dtc mean = 20.75
#dtc median = 9.61
joined_tipping_data_anyilc_filter_CS_IDC_neo<- joined_tipping_data_anyilc_filter_CS_IDC_neo %>%
     mutate(dtccut = case_when(
  dtc_cont  < 9.61  ~ 0,
  dtc_cont >= 9.61 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_CS_IDC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

   coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ dtccut , data =  joined_tipping_data_anyilc_filter_CS_IDC_neo)  %>% 
     gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype
```


```{r}
#evaluate OPTIMIZED CUTOFF IDC NEO IE/FC CTC
joined_tipping_data_anyilc_filter_IE_FC_IDC_neo<- joined_tipping_data_anyilc_filter_IE_FC_IDC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.32  ~ 0,
  ctc_cont >= 0.32 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut + age + stage + grade + subtype, data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_IE_FC_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#evaluate OPTIMIZED CUTOFF ILC NEO CS

joined_tipping_data_anyilc_filter_CS_ILC_neo<- joined_tipping_data_anyilc_filter_CS_ILC_neo %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.13  ~ 0,
  ctc_cont >= 0.13 ~ 1))

#BCSS 

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ ctccut , data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ ageatdx + stage + grade + subtype

#DRFS

coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ ctccut, data =  joined_tipping_data_anyilc_filter_CS_ILC_neo)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
```


```{r}
joined_tipping_data_anyilc_filter_CS_IDC_both <- joined_tipping_data_anyilc_filter_CS_both %>%
   filter(anyilc == 0 )

joined_tipping_data_anyilc_filter_CS_ILC_both <- joined_tipping_data_anyilc_filter_CS_both %>%
   filter(anyilc == 1 )

joined_tipping_data_anyilc_filter_IE_FC_ILC_both <- joined_tipping_data_anyilc_filter_IE_FC_both %>%
   filter(anyilc == 1 )

joined_tipping_data_anyilc_filter_IE_FC_IDC_both <- joined_tipping_data_anyilc_filter_IE_FC_both %>%
   filter(anyilc == 0 )

joined_tipping_data_anyilc_filter_IE_FC_ILC_both <- joined_tipping_data_anyilc_filter_IE_FC_ILC_both %>%
     mutate(combcut = case_when(
  dtc_cont  < 20.85 & ctc_cont < 0.14 ~ "CTC-/DTC-",
  dtc_cont >= 20.85 & ctc_cont >= 0.14 ~ "CTC+/DTC+",
  dtc_cont >= 20.85 & ctc_cont < 0.14 ~ "CTC-/DTC+",
  dtc_cont  < 20.85 & ctc_cont >= 0.14 ~ "CTC+/DTC-"))

table(joined_tipping_data_anyilc_filter_IE_FC_ILC_both$combcut)
18/(11+46+2+18)

summary(joined_tipping_data_anyilc_filter_CS_ILC_both)

joined_tipping_data_anyilc_filter_CS_ILC_both <- joined_tipping_data_anyilc_filter_CS_ILC_both %>%
     mutate(combcut = case_when(
  dtc_cont  < 14.1 & ctc_cont < 0.0634 ~ "CTC-/DTC-",
  dtc_cont >= 14.1 & ctc_cont >= 0.0634 ~ "CTC+/DTC+",
  dtc_cont >= 14.1 & ctc_cont < 0.0634 ~ "CTC-/DTC+",
  dtc_cont  < 14.1 & ctc_cont >= 0.0634 ~ "CTC+/DTC-"))

table(joined_tipping_data_anyilc_filter_CS_ILC_both$combcut)
34/(4+15+16+34)


joined_tipping_data_anyilc_filter_IE_FC_IDC_both <- joined_tipping_data_anyilc_filter_IE_FC_IDC_both %>%
     mutate(combcut = case_when(
  dtc_cont  < 21.26 & ctc_cont < 0.8 ~ "CTC-/DTC-",
  dtc_cont >= 21.26 & ctc_cont >= 0.8 ~ "CTC+/DTC+",
  dtc_cont >= 21.26 & ctc_cont < 0.8 ~ "CTC-/DTC+",
  dtc_cont  < 21.26 & ctc_cont >= 0.8 ~ "CTC+/DTC-"))

summary(joined_tipping_data_anyilc_filter_IE_FC_IDC_both)

table(joined_tipping_data_anyilc_filter_IE_FC_IDC_both$combcut)
178/(9+58+40+178)

joined_tipping_data_anyilc_filter_CS_IDC_both <- joined_tipping_data_anyilc_filter98_CS_IDC_both %>%
     mutate(combcut = case_when(
  dtc_cont  < 28.49 & ctc_cont < 0.0927 ~ "CTC-/DTC-",
  dtc_cont >= 28.49 & ctc_cont >= 0.0927 ~ "CTC+/DTC+",
  dtc_cont >= 28.49 & ctc_cont < 0.0927 ~ "CTC-/DTC+",
  dtc_cont  < 28.49 & ctc_cont >= 0.0927 ~ "CTC+/DTC-"))

summary(joined_tipping_data_anyilc_filter_CS_IDC_both)
table(joined_tipping_data_anyilc_filter_CS_IDC_both$combcut)
236/(11+81+37+236)

coxph(Surv(time_os, deathduetobreastcanceryes1no0) ~ combcut  + age + stage + grade + subtype
 , data =  joined_tipping_data_anyilc_filter_CS_IDC_both)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#+ + age + stage + grade + subtype



coxph(Surv(time_drfs, distantrecurrenceyes1no0) ~ combcut
 , data =  joined_tipping_data_anyilc_filter_CS_IDC_both)  %>% 
  gtsummary::tbl_regression(exp = TRUE)
#++ age + stage + grade + subtype
```
#follow up analysis after revisions 

```{r}

joined_tipping_data_anyilc_filter_both %>%
  select(ctc_cont, dtc_cont, ctcmethod) %>%
  tbl_summary(by = ctcmethod,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()



joined_tipping_data_anyilc_filter_ILC_both_noneo <- joined_tipping_data_anyilc_filter%>%
  filter(neoadj == 0)%>%
    filter(anyilc == 1)

joined_tipping_data_anyilc_filter_ILC_both_noneo %>%
  select(ctc_cont, dtc_cont, ctcmethodclean) %>%
  tbl_summary(by = ctcmethodclean,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_IDC_both_noneo <- joined_tipping_data_anyilc_filter%>%
  filter(neoadj == 0)%>%
    filter(anyilc == 0)

joined_tipping_data_anyilc_filter_IDC_both_noneo %>%
  select(ctc_cont, dtc_cont, ctcmethodclean) %>%
  tbl_summary(by = ctcmethodclean,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_ILC_both_neo <- joined_tipping_data_anyilc_filter_both%>%
  filter(neoadj == 1)%>%
    filter(anyilc == 1)

joined_tipping_data_anyilc_filter_ILC_both_neo %>%
  select(ctc_cont, dtc_cont, ctcmethod) %>%
  tbl_summary(by = ctcmethod,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()



joined_tipping_data_anyilc_filter_IDC_both_neo <- joined_tipping_data_anyilc_filter_both%>%
  filter(neoadj == 1)%>%
    filter(anyilc == 0)

joined_tipping_data_anyilc_filter_IDC_both_neo %>%
  select(ctc_cont, dtc_cont, ctcmethod) %>%
  tbl_summary(by = ctcmethod,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()



joined_tipping_data_anyilc_filter_both_CS <- joined_tipping_data_anyilc_filter_both%>%
  filter(ctcmethod=="CellSearch")
   
joined_tipping_data_anyilc_filter_both_CS %>%
  select(ctc_cont, dtc_cont, anyilc) %>%
  tbl_summary(by = anyilc,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_both_nonneo_CS <- joined_tipping_data_anyilc_filter_both%>%
  filter(ctcmethod=="CellSearch")%>%
  filter(neoadj==0)
   
joined_tipping_data_anyilc_filter_both_nonneo_CS %>%
  select(ctc_cont, dtc_cont, anyilc) %>%
  tbl_summary(by = anyilc,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_both_neo_CS <- joined_tipping_data_anyilc_filter_both%>%
  filter(ctcmethod=="CellSearch")%>%
  filter(neoadj==1)
   
joined_tipping_data_anyilc_filter_both_neo_CS %>%
  select(ctc_cont, dtc_cont, anyilc) %>%
  tbl_summary(by = anyilc,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()



mean(joined_tipping_data_anyilc_filter_both_nonneo_CS$ctc_cont)
mean(joined_tipping_data_anyilc_filter_both_CS$ctc_cont)
mean(joined_tipping_data_anyilc_filter_both_neo_CS$ctc_cont)


joined_tipping_data_anyilc_filter_ILC_both_CS <- joined_tipping_data_anyilc_filter_both%>%
  filter(ctcmethod=="CellSearch")%>%
  filter(anyilc==1)


joined_tipping_data_anyilc_filter_IDC_both_CS <- joined_tipping_data_anyilc_filter_both%>%
  filter(ctcmethod=="CellSearch")%>%
  filter(anyilc==0)

mean(joined_tipping_data_anyilc_filter_IDC_both_CS$ctc_cont)


joined_tipping_data_anyilc_filter_both_CS <- joined_tipping_data_anyilc_filter_both_CS %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.088  ~ "CTC-",
  ctc_cont >= 0.088 ~ "CTC+")) 


joined_tipping_data_anyilc_filter_both_CS %>%
  select(ctccut, anyilc) %>%
  tbl_summary(by = anyilc,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

joined_tipping_data_anyilc_filter_both_nonneo_CS <- joined_tipping_data_anyilc_filter_both_nonneo_CS %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.09  ~ "CTC-",
  ctc_cont >= 0.09 ~ "CTC+")) 

joined_tipping_data_anyilc_filter_both_nonneo_CS %>%
  select(ctccut, anyilc) %>%
  tbl_summary(by = anyilc,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()


joined_tipping_data_anyilc_filter_both_neo_CS <- joined_tipping_data_anyilc_filter_both_neo_CS %>%
     mutate(ctccut = case_when(
  ctc_cont  < 0.08  ~ "CTC-",
  ctc_cont >= 0.08 ~ "CTC+")) 

joined_tipping_data_anyilc_filter_both_neo_CS %>%
  select(ctccut, anyilc) %>%
  tbl_summary(by = anyilc,missing = "no", statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p(
     hist,
  test = list(all_continuous() ~ "t.test", all_categorical() ~ "fisher.test"),
  pvalue_fun = NULL,
  group = NULL,
  include = everything(),
  test.args = NULL,
  exclude = NULL
  ) %>%
  add_overall() %>%
  add_n() %>%
  bold_labels()

#which patients had no age
joined_tipping_data_anyilc_filter_both_age<-joined_tipping_data_anyilc_filter_both%>%
filter(is.na(ageatdx))
list<-joined_tipping_data_anyilc_filter_both_age$patientid
list<-as.data.frame(list)

write.csv(list, "~/Documents/Vantveer_Lab/ILC_CTC_DTC/PID_AGE_NA.csv", row.names=FALSE)

#figure for DTC like figure 1 
#DTC only cellsearch method 
joined_tipping_data_anyilc_filter_both$dtc_cont
joined_tipping_data_anyilc_filter_both_dtc<-joined_tipping_data_both%>%
filter(!is.na(dtc_cont))#810
dim(joined_tipping_data_anyilc_filter_both_dtc)

joined_tipping_data_anyilc_filter_both_dtc_neo<- joined_tipping_data_anyilc_filter_both_dtc %>%
  filter(neoadj==1)

dim(joined_tipping_data_anyilc_filter_both_dtc_neo)

joined_tipping_data_anyilc_filter_both_dtc_neo_ILC <- joined_tipping_data_anyilc_filter_both_dtc_neo%>%
  filter(anyilc == 1)
dim(joined_tipping_data_anyilc_filter_both_dtc_neo_ILC)

joined_tipping_data_anyilc_filter_both_dtc_neo_IDC <- joined_tipping_data_anyilc_filter_both_dtc_neo%>%
  filter(anyilc == 0)
dim(joined_tipping_data_anyilc_filter_both_dtc_neo_IDC)


joined_tipping_data_anyilc_filter_both_dtc_nonneo<- joined_tipping_data_anyilc_filter_both_dtc %>%
  filter(neoadj==0)

dim(joined_tipping_data_anyilc_filter_both_dtc_nonneo)


joined_tipping_data_anyilc_filter_both_dtc_nonneo_ILC <- joined_tipping_data_anyilc_filter_both_dtc_nonneo%>%
  filter(anyilc == 1)
dim(joined_tipping_data_anyilc_filter_both_dtc_nonneo_ILC)


joined_tipping_data_anyilc_filter_both_dtc_nonneo_IDC <- joined_tipping_data_anyilc_filter_both_dtc_nonneo%>%
  filter(anyilc == 0)
dim(joined_tipping_data_anyilc_filter_both_dtc_nonneo_IDC)

####
All_TIPPING_Data_HistNA<-All_TIPPING_Data%>%
filter(cleanhistology == ".")
